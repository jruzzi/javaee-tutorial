
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Protocol Upgrade Processing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
  </head>
  <body>

<div id="preamble">
<div class="sectionbody">
<table id="top" class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 45%;">
<col style="width: 5%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java Platform, Enterprise Edition The Java EE Tutorial</strong><br>
<strong>Release 8 Java Platform, Enterprise Edition</strong><br>
E63026-01</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="toc.html"><span class="image"><img src="img/toc.gif" alt="Go To Table Of Contents"></span><br>
Contents</a></p></td>
</tr>
</tbody>
</table>
<hr>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 5%;">
<col style="width: 5%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="servlets013.html"><span class="image"><img src="img/leftnav.gif" alt="Previous"></span><br>
Previous</a> </p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="servlets015.html"><span class="image"><img src="img/rightnav.gif" alt="Next"></span><br>
Next</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="protocol-upgrade-processing">17.14 Protocol Upgrade Processing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In HTTP/1.1, clients can request to switch to a different protocol on
the current connection by using the <code>Upgrade</code> header field. If the
server accepts the request to switch to the protocol indicated by the
client, it generates an HTTP response with status 101 (switching
protocols). After this exchange, the client and the server communicate
using the new protocol.</p>
</div>
<div class="paragraph">
<p>For example, a client can make an HTTP request to switch to the XYZP
protocol as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">GET /xyzpresource HTTP/1.1
Host: localhost:8080
Accept: text/html
Upgrade: XYZP
Connection: Upgrade
OtherHeaderA: Value</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client can specify parameters for the new protocol using HTTP
headers. The server can accept the request and generate a response as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">HTTP/1.1 101 Switching Protocols
Upgrade: XYZP
Connection: Upgrade
OtherHeaderB: Value

(XYZP data)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Java EE supports the HTTP protocol upgrade functionality in servlets, as
described in <a href="#BEIBDHAG">Table 17-7</a>.</p>
</div>
<div class="paragraph">
<p><a id="sthref109"></a><a id="BEIBDHAG"></a></p>
</div>
<div class="paragraph">
<p>Table 17-7 Protocol Upgrade Support</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 31%;">
<colgroup>
<col style="width: 99.0099%;">
<col style="width: 0.9901%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Class or Interface</th>
<th class="tableblock halign-left valign-top">Method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HttpServletRequest</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>HttpUpgradeHandler upgrade(Class handler)</code></p>
</div>
<div class="paragraph">
<p>The upgrade method starts the protocol upgrade processing. This method
instantiates a class that implements the <code>HttpUpgradeHandler</code> interface
and delegates the connection to it.</p>
</div>
<div class="paragraph">
<p>You call the <code>upgrade</code> method inside a service method when accepting a
request from a client to switch protocols.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HttpUpgradeHandler</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>void init(WebConnection wc)</code></p>
</div>
<div class="paragraph">
<p>The <code>init</code> method is called when the servlet accepts the request to
switch protocols. You implement this method and obtain input and output
streams from the <code>WebConnection</code> object to implement the new protocol.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HttpUpgradeHandler</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>void destroy()</code></p>
</div>
<div class="paragraph">
<p>The <code>destroy</code> method is called when the client disconnects. You
implement this method and free any resources associated with processing
the new protocol.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WebConnection</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>ServletInputStream getInputStream()</code></p>
</div>
<div class="paragraph">
<p>The <code>getInputStream</code> method provides access to the input stream of the
connection. You can use <a href="servlets013.html#BEIHICDH">Nonblocking I/O</a>
with the returned stream to implement the new protocol.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WebConnection</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>ServletOutputStream getOutputStream()</code></p>
</div>
<div class="paragraph">
<p>The <code>getOutputStream</code> method provides access to the output stream of the
connection. You can use <a href="servlets013.html#BEIHICDH">Nonblocking I/O</a>
with the returned stream to implement the new protocol.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="literalblock">
<div class="content">
<pre>+</pre>
</div>
</div>
<div class="paragraph">
<p>The following code demonstrates how to accept an HTTP protocol upgrade
request from a client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@WebServlet(urlPatterns={"/xyzpresource"})
public class XYZPUpgradeServlet extends HttpServlet {
   @Override
   public void doGet(HttpServletRequest request,
                     HttpServletResponse response) {
      if ("XYZP".equals(request.getHeader("Upgrade"))) {
         /* Accept upgrade request */
         response.setStatus(101);
         response.setHeader("Upgrade", "XYZP");
         response.setHeader("Connection", "Upgrade");
         response.setHeader("OtherHeaderB", "Value");
         /* Delegate the connection to the upgrade handler */
         XYZPUpgradeHandler = request.upgrade(XYZPUpgradeHandler.class);
         /* (the service method returns immedately) */
      } else {
         /* ... write error response ... */
      }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>XYZPUpgradeHandler</code> class handles the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">public class XYZPUpgradeHandler implements HttpUpgradeHandler {
   @Override
   public void init(WebConnection wc) {
      ServletInputStream input = wc.getInputStream();
      ServletOutputStream output = wc.getOutputStream();
      /* ... implement XYZP using these streams (protocol-specific) ... */
   }
   @Override
   public void destroy() { ... }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class that implements <code>HttpUpgradeHandler</code> uses the streams from the
current connection to communicate with the client using the new
protocol. See the Servlet 4.0 specification at
<code>http://jcp.org/en/jsr/detail?id=369</code> for details on HTTP protocol
upgrade support.</p>
</div>
<hr>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 5%;">
<col style="width: 5%;">
<col style="width: 10%;">
<col style="width: 65%;">
<col style="width: 10%;">
<col style="width: 5%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="servlets013.html"><span class="image"><img src="img/leftnav.gif" alt="Previous"></span><br>
Previous</a> </p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="servlets015.html"><span class="image"><img src="img/rightnav.gif" alt="Next"></span><br>
Next</a></p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="img/oracle.gif" alt="Oracle Logo"></span>
<a href="cpyr.html"><br>
Copyright © 2014, 2017, Oracle and/or its affiliates. All rights reserved.</a></p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="toc.html"><span class="image"><img src="img/toc.gif" alt="Go To Table Of Contents"></span><br>
Contents</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>

  </body>
</html>